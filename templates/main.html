<!DOCTYPE HTML>
<html>

<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>Arxiv Sanity Preserver</title>

    <!-- MathJax -->
    <script type="text/x-mathjax-config">
        MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
    </script>
    <script type="text/javascript" async
            src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML">
    </script>

    <!-- CSS -->
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">

    <!-- Favicon -->
    <link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}"/>

    <!-- JS -->
    <script src="{{ url_for('static', filename='jquery-1.8.3.min.js') }}"></script>
    <script src="{{ url_for('static', filename='d3.min.js') }}"></script>
    <script src="{{ url_for('static', filename='as-common.js') }}"></script>

    <!-- Google Analytics JS -->
    <script>
        (function (i, s, o, g, r, a, m) {
            i['GoogleAnalyticsObject'] = r;
            i[r] = i[r] || function () {
                (i[r].q = i[r].q || []).push(arguments)
            }, i[r].l = 1 * new Date();
            a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
            a.async = 1;
            a.src = g;
            m.parentNode.insertBefore(a, m)
        })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

        ga('create', 'UA-3698471-25', 'auto');
        ga('send', 'pageview');

    </script>
    <script>
        (function () {
            var storedTheme = localStorage.getItem('theme');
            if (storedTheme === 'dark') {
                document.documentElement.classList.add('dark-mode');
            }
        })();

        function initThemeToggle() {
            var toggleButton = document.querySelector('.theme-toggle');
            if (!toggleButton) {
                return;
            }
            var setLabel = function () {
                var isDark = document.documentElement.classList.contains('dark-mode');
                toggleButton.innerHTML = isDark
                    ? '<span class="theme-icon" aria-hidden="true">‚òÄÔ∏è</span>'
                    : '<span class="theme-icon" aria-hidden="true">üåô</span>';
                toggleButton.setAttribute('aria-pressed', isDark ? 'true' : 'false');
                toggleButton.setAttribute('aria-label', isDark ? 'Switch to light mode' : 'Switch to dark mode');
            };
            setLabel();
            toggleButton.addEventListener('click', function () {
                document.documentElement.classList.toggle('dark-mode');
                var isDark = document.documentElement.classList.contains('dark-mode');
                localStorage.setItem('theme', isDark ? 'dark' : 'light');
                setLabel();
            });
        }
    </script>

    <script>

        // passed in from flask as json
        var tweets = {{tweets | tojson }};

        var papers = {{ papers | tojson }};

        var pid_to_users = {{pid_to_users | tojson}};

        var msg = "{{ msg }}";
        var render_format = "{{ render_format }}";
        var username = "{{ g.user.username }}";
        var numresults = "{{ numresults }}";
        var show_prompt = "{{ show_prompt }}";

        var urlq = ''; // global will be read in to QueryString when load is done

        var ingestPoller = null;
        var ingestLogIndex = 0;
        var recomputePoller = null;
        var recomputeLastStatus = null;

        function updateIngestProgress(step) {
            var status = $('#ingest-status-text');
            var bar = $('#ingest-progress-bar');
            var progressShell = $('.ingest-progress');

            status.text(step.label);
            bar.css('width', step.percent + '%');
            progressShell.attr('aria-valuenow', step.percent);
        }

        function showIngestOverlay() {
            var overlay = $('#ingest-overlay');

            if (ingestPoller) {
                clearInterval(ingestPoller);
            }
            ingestLogIndex = 0;
            updateIngestProgress({label: 'Preparing to start the ingest process...', percent: 0});
            $('#ingest-log').empty();

            overlay.attr('aria-hidden', 'false').addClass('visible');
        }

        function pollIngestStatus(jobId) {
            ingestPoller = setInterval(function () {
                $.getJSON('/ingest/status/' + jobId, function (data) {
                    updateIngestProgress({label: data.label, percent: data.percent});
                    if (data.messages && data.messages.length > ingestLogIndex) {
                        var log = $('#ingest-log');
                        for (var i = ingestLogIndex; i < data.messages.length; i++) {
                            var line = $('<div></div>').text(data.messages[i]);
                            log.append(line);
                        }
                        ingestLogIndex = data.messages.length;
                        log.scrollTop(log[0].scrollHeight);
                    }

                    if (data.done) {
                        clearInterval(ingestPoller);
                        ingestPoller = null;
                        if (data.error) {
                            $('#ingest-status-text').text('Ingest failed');
                        }
                    }
                }).fail(function () {
                    clearInterval(ingestPoller);
                    ingestPoller = null;
                });
            }, 1000);
        }
        function showRecomputePanel(message, percent, level) {
            var panel = $('#recompute-status-panel');
            var text = $('#recompute-status-text');
            var progress = $('#recompute-status-percent');
            var levelClass = level ? 'recompute-' + level : '';

            text.text(message);
            progress.text(percent + '%');
            panel.removeClass('recompute-error recompute-info recompute-success');
            if (levelClass) {
                panel.addClass(levelClass);
            }
            panel.attr('aria-hidden', 'false').addClass('visible');
        }

        function hideRecomputePanel() {
            $('#recompute-status-panel').attr('aria-hidden', 'true').removeClass('visible');
        }


        function updateRecomputeStatus(state) {
            var status = state.status || 'idle';
            recomputeLastStatus = status;
            var isActive = status === 'running' || status === 'queued';
            var percent = typeof state.percent === 'number' ? state.percent : 0;
            var message = state.message || (status === 'queued' ? 'Recompute queued...' : 'Recomputing caches...');

            if (isActive) {
                showRecomputePanel(message, percent, 'info');
            } else {
                hideRecomputePanel();
                updateRecomputeBadge(status === 'finished');
            }
        }

        function fetchRecomputeStatus() {
            $.getJSON('/recompute/status', function (data) {
                updateRecomputeStatus(data);
            });
        }

        function startRecomputePolling() {
            if (!recomputePoller) {
                recomputePoller = setInterval(fetchRecomputeStatus, 2000);
            }
            fetchRecomputeStatus();
        }


        // when page loads...
        $(document).ready(function () {

            urlq = QueryString.q;

            // display message, if any
            if (msg !== '') {
                d3.select("#rtable").append('div').classed('msg', true).html(msg);
            }

            // add papers to #rtable
            var done = addPapers(10, false);
            if (done) {
                $("#loadmorebtn").hide();
            }

            // set up inifinite scrolling for adding more papers
            $(window).on('scroll', function () {
                var scrollTop = $(document).scrollTop();
                var windowHeight = $(window).height();
                var bodyHeight = $(document).height() - windowHeight;
                var scrollPercentage = (scrollTop / bodyHeight);
                if (scrollPercentage > 0.9) {
                    var done = addPapers(5, true);
                    if (done) {
                        $("#loadmorebtn").hide();
                    }
                }
            });

            // just in case scrolling is broken somehow, provide a button handler explicit
            $("#loadmorebtn").on('click', function () {
                var done = addPapers(5, true);
                if (done) {
                    $("#loadmorebtn").hide();
                }
            });

            if (papers.length === 0) {
                $("#loadmorebtn").hide();
            }

            if (!(typeof urlq == 'undefined')) {
                d3.select("#qfield").attr('value', urlq.replace(/\+/g, " "));
            }

            var xb = $("#xbanner");
            if (xb.length !== 0) {
                xb.click(function () {
                    $("#banner").slideUp('fast');
                })
            }

            $("#goaway").on('click', function () {
                $("#prompt").slideUp('fast');
                $.post("/goaway", {}).done(function (data) {
                });
            });

            var topicSearch = $("#topic-search");
            var topicTags = $("#topic-tags");

            if (topicTags.length && topicSearch.length) {
                var tags = topicTags.find('.tag');

                topicSearch.on('input', function () {
                    var query = $(this).val().toLowerCase().trim();

                    if (query === '') {
                        tags.show();
                        topicTags.addClass('limited');
                    } else {
                        tags.each(function () {
                            var text = $(this).text().toLowerCase();
                            $(this).toggle(text.indexOf(query) !== -1);
                        });
                        topicTags.addClass('limited');
                    }
                });
            }

            var filterForm = $('.filter-form');
            if (filterForm.length) {
                filterForm.on('reset', function () {
                    setTimeout(function () {
                        if (topicSearch.length && topicTags.length) {
                            topicSearch.val('');
                            topicTags.find('.tag').show();
                            topicTags.addClass('limited');
                        }
                    }, 0);
                });
            }

            var ingestForm = $('#ingest-form');
            if (ingestForm.length) {
                ingestForm.on('submit', function (event) {
                    event.preventDefault();
                    showIngestOverlay();

                    $.post('/ingest', ingestForm.serialize(), function (data) {
                        if (data.error) {
                            $('#ingest-status-text').text(data.error);
                            return;
                        }
                        if (data.job_id) {
                            pollIngestStatus(data.job_id);
                        }
                    }, 'json').fail(function () {
                        $('#ingest-status-text').text('Could not start ingest. Please try again.');
                    });
                });
            }
            startRecomputePolling();

            initLayoutToggle('.layout-btn');
            initThemeToggle();
        });

    </script>
</head>

<body>

<!-- HEADER -->
<div id="titdiv">
    <!-- Site information/banner -->
    <div class="header-actions">
        <button type="button" class="theme-toggle" aria-label="Switch to dark mode" aria-pressed="false">
            <span class="theme-icon" aria-hidden="true">üåô</span>
        </button>
    </div>
    <a href="/">
        <div id="tittxt">
            <h1>Arxiv Sanity Preserver</h1>
            <div class="site-subtitle">
                Modified from Karpathy's version with updated UI & backend.<br>
                Serving last {{ totpapers }} papers from cs.[CV|CL|LG|AI|NE]/stat.M
            </div>
        </div>
    </a>
</div>

<!-- FLASHES -->
{% with flashes = get_flashed_messages() %}
{% if flashes %}
<div id="flashesdiv">
    <ul class="flashes">
        {% for message in flashes %}
        <li>{{ message }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}
{% endwith %}

<!-- MAIN LAYOUT: SIDEBAR + CONTENT -->
<div class="layout-container">

    <!-- SIDEBAR: FILTERS -->
    <aside class="filter-panel">
        <h2>Filters</h2>
        <form class="filter-form" method="get" action="/search">

            <!-- SEARCH BAR -->
            <div class="filter-group">
                <label for="qfield">Search</label>
                <input name="q" type="search" id="qfield" placeholder="Keywords..." value="{{ search_query }}">
            </div>

            <!-- TOPICS (Multi-select tags) -->

            {% set sorted_topics = topics|sort(attribute='count', reverse=True) %}
            {% set selected_sorted = sorted_topics|selectattr('name', 'in', selected_topics)|list %}
            {% set unselected_sorted = sorted_topics|rejectattr('name', 'in', selected_topics)|list %}
            {% set display_topics = selected_sorted + unselected_sorted %}
            {% set max_label_length = 18 %}
            <div class="filter-group">
                <label>Topics</label>
                <div class="topic-cluster">
                    <input
                            type="search"
                            id="topic-search"
                            class="topic-search"
                            placeholder="Search topics..."
                            autocomplete="off"
                    />
                    <div class="tag-list limited" id="topic-tags">
                        {% for topic in display_topics %}
                        {% set full_name = topic.display_name %}
                        {% if full_name|length > max_label_length %}
                        {% set truncated_candidate = full_name[:max_label_length] %}
                        {% set trimmed = truncated_candidate.rsplit(' ', 1)[0] %}
                        {% set truncated_name = (trimmed if trimmed else truncated_candidate).rstrip() ~ '...' %}
                        {% else %}
                        {% set truncated_name = full_name %}
                        {% endif %}
                        <label class="tag">
                            <input
                                    type="checkbox"
                                    name="topics[]"
                                    value="{{ topic.name }}"
                                    {% if topic.name in selected_topics %}checked{% endif %}
                            />
                            <span data-full-name="{{ full_name }}" title="{{ full_name }}">{{ truncated_name }} ({{ topic.count }})</span>
                        </label>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- SCORE FILTER -->
            <div class="filter-group">
                <label for="scorebar">Minimum Score</label>
                <input
                        id="scorebar"
                        name="min_score"
                        type="text"
                        placeholder="e.g. 2.5"
                        inputmode="decimal"
                        pattern="[0-9]*[.]?[0-9]*"
                        value="{{ min_score }}"
                />
            </div>

            <!-- AVAILABILITY FILTERS -->
            <div class="filter-group">
                <label>Others</label>
                <label class="checkbox">
                    <input
                            type="checkbox"
                            name="open_source"
                            value="1"
                            {% if open_source %}checked{% endif %}
                    />
                    <span>Open-Source</span>
                </label>
                <label class="checkbox">
                    <input
                            type="checkbox"
                            name="publication_status"
                            value="presented"
                            {% if 'presented' in publication_statuses %}checked{% endif %}
                    />
                    <span>Presented at conference</span>
                </label>
            </div>


            <!-- SORT OPTIONS -->
            <div class="sort-options">
                <div class="sort-row">
                    <div class="filter-group sort-control">
                        <label for="sortby">Sort By</label>
                        <div class="sort-control-row">
                            <div class="select-wrapper sort-select">
                                {% set sort_by_value = sort_by or 'date' %}
                                <select id="sortby" name="sortby" class="select-input">
                                    <option value="date" {% if sort_by_value==
                                    'date' %}selected{% endif %}>Date</option>
                                    <option value="score" {% if sort_by_value==
                                    'score' %}selected{% endif %}>Score</option>
                                    <option value="citation" {% if sort_by_value==
                                    'citation' %}selected{% endif %}>Citation</option>
                                </select>
                            </div>
                            {% set sort_order_value = sort_order or 'desc' %}
                            <div class="order-toggle" id="sortorder">
                                <label class="order-option">
                                    <input type="radio" name="sortorder" value="desc" {% if sort_order_value== 'desc'
                                    %}checked{% endif %}>
                                    <span class="order-button order-desc">DESC</span>
                                </label>
                                <label class="order-option">
                                    <input type="radio" name="sortorder" value="asc" {% if sort_order_value== 'asc'
                                    %}checked{% endif %}>
                                    <span class="order-button order-asc">ASC</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ACTIONS -->
            <div class="filter-actions">
                <button type="submit" class="btn-primary">Search</button>
                <button type="reset" class="btn-secondary">Reset</button>
            </div>
        </form>

        <div class="ingest-card">
            <h3>Add Paper</h3>
            <form id="ingest-form" class="ingest-form" method="post" action="/ingest">
                <div class="filter-group">
                    <label for="paper-id-input">arXiv identifier</label>
                    <input
                            id="paper-id-input"
                            name="paper_id"
                            type="text"
                            placeholder="e.g. 1512.08756v2"
                            required
                    />
                </div>
                <p class="ingest-help">We will download the PDF, extract text, and refresh caches for the new paper.</p>
                <button type="submit" class="btn-primary">Add paper</button>
            </form>
            <div class="recompute-status-panel" id="recompute-status-panel" aria-hidden="true">
                <div class="recompute-status-content">
                    <span id="recompute-status-text">Recomputing caches...</span>
                    <span class="recompute-progress" id="recompute-status-percent">0%</span>
                </div>
            </div>
        </div>
    </aside>

    <!-- MAIN CONTENT: PAPERS -->
    <main id="maindiv">
        <div class="layout-toolbar">
            <span class="layout-label">Layout</span>
            <div class="layout-toggle" role="group" aria-label="Toggle paper layout">
                <button
                        type="button"
                        class="layout-btn"
                        data-layout="single"
                        aria-label="Single column layout"
                        title="Single column layout"
                >
                    ‚ñ¢
                </button>
                <button type="button" class="layout-btn" data-layout="double" aria-label="Two-column layout"
                        title="Two-column layout">
                    <svg aria-hidden="true" viewBox="0 0 24 24" width="18" height="18" fill="currentColor">
                        <rect x="3" y="3" width="4" height="4" rx="0.6"></rect>
                        <rect x="10" y="3" width="4" height="4" rx="0.6"></rect>
                        <rect x="17" y="3" width="4" height="4" rx="0.6"></rect>

                        <rect x="3" y="10" width="4" height="4" rx="0.6"></rect>
                        <rect x="10" y="10" width="4" height="4" rx="0.6"></rect>
                        <rect x="17" y="10" width="4" height="4" rx="0.6"></rect>

                        <rect x="3" y="17" width="4" height="4" rx="0.6"></rect>
                        <rect x="10" y="17" width="4" height="4" rx="0.6"></rect>
                        <rect x="17" y="17" width="4" height="4" rx="0.6"></rect>
                    </svg>
                </button>
            </div>
        </div>
        {% if no_results_message %}
        <div class="msg">{{ no_results_message }}</div>
        {% endif %}

        <div id="rtable" data-layout="double"></div>

        <div id="loadmore">
            <button id="loadmorebtn">Load more</button>
        </div>
    </main>
</div>

<div class="ingest-overlay" id="ingest-overlay" aria-hidden="true">
    <div class="ingest-modal" role="dialog" aria-labelledby="ingest-modal-title" aria-describedby="ingest-status-text">
        <h3 id="ingest-modal-title">Adding new paper</h3>
        <p class="ingest-status" id="ingest-status-text">Preparing to start the ingest process...</p>
        <div class="ingest-progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="8">
            <div class="ingest-progress-bar" id="ingest-progress-bar" style="width: 8%;"></div>
        </div>
        <div class="ingest-log" id="ingest-log" aria-live="polite"></div>
        <p class="ingest-note">We'll download the PDF, extract the text, and refresh caches. Feel free to keep this tab
            open while we work.</p>
    </div>
</div>

<br><br>
</body>

</html>
