<!DOCTYPE HTML>
<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Arxiv Sanity Preserver</title>

<!-- MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});
</script>
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS_CHTML">
</script>

<!-- CSS -->
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='style.css') }}">

<!-- Favicon -->
<link rel="shortcut icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}" />

<!-- JS -->
<script src="{{ url_for('static', filename='jquery-1.8.3.min.js') }}"></script>
<script src="{{ url_for('static', filename='d3.min.js') }}"></script>
<script src="{{ url_for('static', filename='as-common.js') }}"></script>

<!-- Google Analytics JS -->
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-3698471-25', 'auto');
  ga('send', 'pageview');

</script>

<script>

// passed in from flask as json
var tweets = {{ tweets | tojson }};
var papers = {{ papers | tojson }};
var pid_to_users = {{ pid_to_users | tojson }};
var msg = "{{ msg }}";
var render_format = "{{ render_format }}";
var username = "{{ g.user.username }}";
var numresults = "{{ numresults }}";
var show_prompt = "{{ show_prompt }}";

var urlq = ''; // global will be read in to QueryString when load is done

var ingestProgressSteps = [
  { label: 'Validating identifier...', percent: 12 },
  { label: 'Fetching arXiv metadata...', percent: 32 },
  { label: 'Downloading PDF...', percent: 58 },
  { label: 'Extracting text from PDF...', percent: 78 },
  { label: 'Refreshing caches...', percent: 100 }
];
var ingestStepIndex = 0;
var ingestProgressTimer = null;

function updateIngestProgress(step) {
  var status = $('#ingest-status-text');
  var bar = $('#ingest-progress-bar');
  var progressShell = $('.ingest-progress');

  status.text(step.label);
  bar.css('width', step.percent + '%');
  progressShell.attr('aria-valuenow', step.percent);
}

function showIngestOverlay() {
  var overlay = $('#ingest-overlay');

  if(ingestProgressTimer) { clearInterval(ingestProgressTimer); }
  ingestStepIndex = 0;
  updateIngestProgress(ingestProgressSteps[ingestStepIndex]);

  overlay.attr('aria-hidden', 'false').addClass('visible');

  ingestProgressTimer = setInterval(function(){
    if(ingestStepIndex < ingestProgressSteps.length - 1) {
      ingestStepIndex += 1;
      updateIngestProgress(ingestProgressSteps[ingestStepIndex]);
    } else {
      clearInterval(ingestProgressTimer);
    }
  }, 1200);
}

// when page loads...
$(document).ready(function(){

	urlq = QueryString.q;

  // display message, if any
  if(msg !== '') { d3.select("#rtable").append('div').classed('msg', true).html(msg); }

  // add papers to #rtable
	var done = addPapers(10, false);
  if(done) { $("#loadmorebtn").hide(); }

  // set up inifinite scrolling for adding more papers
  $(window).on('scroll', function(){
    var scrollTop = $(document).scrollTop();
    var windowHeight = $(window).height();
    var bodyHeight = $(document).height() - windowHeight;
    var scrollPercentage = (scrollTop / bodyHeight);
    if(scrollPercentage > 0.9) {
      var done = addPapers(5, true);
      if(done) { $("#loadmorebtn").hide(); }
    }
  });

  // just in case scrolling is broken somehow, provide a button handler explicit
  $("#loadmorebtn").on('click', function(){
    var done = addPapers(5, true);
    if(done) { $("#loadmorebtn").hide(); }
  });

  if(papers.length === 0) { $("#loadmorebtn").hide(); }

	if(!(typeof urlq == 'undefined')) {
		d3.select("#qfield").attr('value', urlq.replace(/\+/g, " "));
	}

  var xb = $("#xbanner");
  if(xb.length !== 0) {
    xb.click(function(){ $("#banner").slideUp('fast'); })
  }

  $("#goaway").on('click', function(){
    $("#prompt").slideUp('fast');
    $.post("/goaway", {}).done(function(data){ });
  });

  var topicSearch = $("#topic-search");
  var topicTags = $("#topic-tags");

  if(topicTags.length && topicSearch.length) {
    var tags = topicTags.find('.tag');

    topicSearch.on('input', function(){
      var query = $(this).val().toLowerCase().trim();

      if(query === '') {
        tags.show();
        topicTags.addClass('limited');
      } else {
        tags.each(function(){
          var text = $(this).text().toLowerCase();
          $(this).toggle(text.indexOf(query) !== -1);
        });
        topicTags.addClass('limited');
      }
    });
  }

  var ingestForm = $('#ingest-form');
  if(ingestForm.length) {
    ingestForm.on('submit', function(){
      showIngestOverlay();
    });
  }

  initLayoutToggle('.layout-btn');
});

</script>
</head>

<body>

<!-- HEADER -->
<div id="titdiv">
  <!-- Site information/banner -->
  <a href="/">
    <div id="tittxt">
      <h1>Arxiv Sanity Preserver</h1>
      <div class="site-subtitle">
        Built in spare time by <a href="https://twitter.com/karpathy">@karpathy</a> to accelerate research.<br>
        Serving last {{ totpapers }} papers from cs.[CV|CL|LG|AI|NE]/stat.ML
      </div>
    </div>
  </a>
</div>

<!-- FLASHES -->
{% with flashes = get_flashed_messages() %}
  {% if flashes %}
    <div id="flashesdiv">
      <ul class="flashes">
      {% for message in flashes %}
        <li>{{ message }}</li>
      {% endfor %}
      </ul>
    </div>
  {% endif %}
{% endwith %}

<!-- MAIN LAYOUT: SIDEBAR + CONTENT -->
<div class="layout-container">
  
  <!-- SIDEBAR: FILTERS -->
  <aside class="filter-panel">
    <h2>Filters</h2>
    <form class="filter-form" method="get" action="/search">
      
      <!-- SEARCH BAR -->
      <div class="filter-group">
        <label for="qfield">Search</label>
        <input name="q" type="search" id="qfield" placeholder="Keywords...">
      </div>

      <!-- TOPICS (Multi-select tags) -->

      {% set sorted_topics = topics|sort(attribute='count', reverse=True) %}
	  {% set selected_sorted = sorted_topics|selectattr('name', 'in', selected_topics)|list %}
      {% set unselected_sorted = sorted_topics|rejectattr('name', 'in', selected_topics)|list %}
      {% set display_topics = selected_sorted + unselected_sorted %}
          {% set max_label_length = 18 %}
      <div class="filter-group">
        <label>Topics</label>
        <div class="topic-cluster">
          <input
            type="search"
            id="topic-search"
            class="topic-search"
            placeholder="Search topics..."
            autocomplete="off"
          />
          <div class="tag-list limited" id="topic-tags">
            {% for topic in display_topics %}
                     {% set full_name = topic.display_name %}
              {% if full_name|length > max_label_length %}
                {% set truncated_candidate = full_name[:max_label_length] %}
                {% set trimmed = truncated_candidate.rsplit(' ', 1)[0] %}
                {% set truncated_name = (trimmed if trimmed else truncated_candidate).rstrip() ~ '...' %}
              {% else %}
                {% set truncated_name = full_name %}
              {% endif %}
              <label class="tag">
                <input
                  type="checkbox"
                  name="topics[]"
                  value="{{ topic.name }}"
                  {% if topic.name in selected_topics %}checked{% endif %}
                />
                <span data-full-name="{{ full_name }}" title="{{ full_name }}">{{ truncated_name }} ({{ topic.count }})</span>
              </label>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- SCORE FILTER -->
      <div class="filter-group">
        <label for="scorebar">Minimum Score</label>
        <input
          id="scorebar"
          name="scorebar"
          type="text"
          placeholder="e.g. 2.5"
          inputmode="decimal"
          pattern="[0-9]*[.]?[0-9]*"
        />
      </div>

      <!-- SORT OPTIONS -->
      <div class="sort-options">
       <div class="sort-row">
          <div class="filter-group sort-control">
            <div class="sort-header">
              <label for="sortby">Sort By</label>
              {% set sort_order = request.args.get('sortorder', 'desc') %}
              <div class="order-toggle" id="sortorder">
                <label class="order-option">
                  <input type="radio" name="sortorder" value="desc" {% if sort_order == 'desc' %}checked{% endif %}>
                  <span class="order-button order-desc">DESC</span>
                </label>
                <label class="order-option">
                  <input type="radio" name="sortorder" value="asc" {% if sort_order == 'asc' %}checked{% endif %}>
                  <span class="order-button order-asc">ASC</span>
                </label>
              </div>
            </div>
            <div class="select-wrapper">
              {% set sort_by = request.args.get('sortby', 'date') %}
              <select id="sortby" name="sortby" class="select-input">
                <option value="date" {% if sort_by == 'date' %}selected{% endif %}>Date</option>
                <option value="score" {% if sort_by == 'score' %}selected{% endif %}>Score</option>
                <option value="citation" {% if sort_by == 'citation' %}selected{% endif %}>Citation</option>
              </select>
            </div>
          </div>
        </div>
      </div>

      <!-- ACTIONS -->
      <div class="filter-actions">
        <button type="submit" class="btn-primary">Apply</button>
        <button type="reset" class="btn-secondary">Reset</button>
      </div>
    </form>

    <div class="ingest-card">
      <h3>Add a paper</h3>
      <form id="ingest-form" class="ingest-form" method="post" action="/ingest">
        <div class="filter-group">
          <label for="paper-id-input">arXiv identifier</label>
          <input
            id="paper-id-input"
            name="paper_id"
            type="text"
            placeholder="e.g. 1512.08756v2"
            required
          />
        </div>
        <p class="ingest-help">We will download the PDF, extract text, and refresh caches for the new paper.</p>
        <button type="submit" class="btn-primary">Add paper</button>
      </form>
    </div>
  </aside>

  <!-- MAIN CONTENT: PAPERS -->
  <main id="maindiv">
    <div class="layout-toolbar">
      <span class="layout-label">Layout</span>
      <div class="layout-toggle" role="group" aria-label="Toggle paper layout">
        <button
          type="button"
          class="layout-btn"
          data-layout="single"
          aria-label="Single column layout"
          title="Single column layout"
        >
          ▢
        </button>
        <button
          type="button"
          class="layout-btn"
          data-layout="double"
          aria-label="Two-column layout"
          title="Two-column layout"
        >
          ▦
        </button>
      </div>
    </div>

    <div id="rtable" data-layout="double"></div>

    <div id="loadmore">
      <button id="loadmorebtn">Load more</button>
    </div>
  </main>

</div>

<div class="ingest-overlay" id="ingest-overlay" aria-hidden="true">
  <div class="ingest-modal" role="dialog" aria-labelledby="ingest-modal-title" aria-describedby="ingest-status-text">
    <h3 id="ingest-modal-title">Adding new paper</h3>
    <p class="ingest-status" id="ingest-status-text">Preparing to start the ingest process...</p>
    <div class="ingest-progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="8">
      <div class="ingest-progress-bar" id="ingest-progress-bar" style="width: 8%;"></div>
    </div>
    <p class="ingest-note">We'll download the PDF, extract the text, and refresh caches. Feel free to keep this tab open while we work.</p>
  </div>
</div>

<br><br>
</body>

</html>
